import{s as i}from"./index-CCO05Osv.js";async function m(e){let s=i.from("problems").select("*");e.search&&e.search.trim()!==""&&(s=s.or(`title.ilike.%${e.search}%,description.ilike.%${e.search}%`)),e.difficulty&&e.difficulty!=="all"&&(s=s.eq("difficulty",e.difficulty)),e.subject&&e.subject!=="all"&&(s=s.eq("subject",e.subject)),e.industry&&e.industry!=="all"&&(s=s.eq("industry",e.industry));const{data:t,error:r}=await s.order("created_at",{ascending:!1});if(r)throw console.error("Error fetching problems:",r),r;return t}async function d(e){const{data:s,error:t}=await i.from("problems").select("*").eq("id",e).single();return t?(console.error("Error fetching problem:",t),null):s}async function u(){var e;try{const{data:s}=await i.auth.getUser(),t=(e=s.user)==null?void 0:e.id;if(!t)return;console.log("ðŸ“¤ Broadcasting attempts_changed for user:",t),i.channel("ui-updates").send({type:"broadcast",event:"attempts_changed",payload:{userId:t}})}catch(s){console.error("Broadcast error:",s)}}const b={async submitAnswer(e){console.log("ðŸŽ¯ submitAnswer called with:",e);const{data:{user:s}}=await i.auth.getUser();if(!s)throw console.error("âŒ No user found in submitAnswer"),new Error("Not authenticated");console.log("âœ… User authenticated:",s.id),console.log("ðŸ“ Submitting answer:",e);try{const{data:t,error:r}=await i.from("submissions").upsert({user_id:s.id,problem_id:e.problem_id,status:e.status,user_answer:e.user_answer,time_spent_minutes:Math.max(0,e.time_spent_minutes),hints_used:e.hints_used||0,accuracy_score:e.accuracy_score,notes:e.notes,whiteboard_data:e.whiteboard_data,feedback:e.feedback,updated_at:new Date().toISOString()},{onConflict:"user_id,problem_id",ignoreDuplicates:!1}).select().single();if(r){console.error("Upsert failed, trying manual check:",r);const{data:n,error:o}=await i.from("submissions").select("*").eq("user_id",s.id).eq("problem_id",e.problem_id).maybeSingle();if(o)throw o;if(n){const{data:a,error:c}=await i.from("submissions").update({status:e.status,user_answer:e.user_answer,time_spent_minutes:Math.max(n.time_spent_minutes,e.time_spent_minutes),hints_used:Math.max(n.hints_used,e.hints_used||0),accuracy_score:e.accuracy_score,notes:e.notes,whiteboard_data:e.whiteboard_data,feedback:e.feedback,updated_at:new Date().toISOString()}).eq("id",n.id).select().single();if(c)throw c;return console.log("Updated existing submission:",a),await u(),a}else{const{data:a,error:c}=await i.from("submissions").insert({user_id:s.id,problem_id:e.problem_id,status:e.status,user_answer:e.user_answer,time_spent_minutes:Math.max(0,e.time_spent_minutes),hints_used:e.hints_used||0,accuracy_score:e.accuracy_score,notes:e.notes,whiteboard_data:e.whiteboard_data,feedback:e.feedback}).select().single();if(c)throw c;return console.log("Created new submission:",a),await u(),a}}return console.log("Upserted submission successfully:",t),await u(),t}catch(t){throw console.error("Error in submitAnswer:",t),t}},async markAsAttempted(e){const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Not authenticated");console.log("Marking problem as attempted:",e);const{data:t,error:r}=await i.from("submissions").select("*").eq("user_id",s.id).eq("problem_id",e).maybeSingle();if(r)throw console.error("Error checking existing submission:",r),r;if(t)return console.log("Submission already exists:",t),await u(),t;const n=await this.submitAnswer({problem_id:e,status:"attempted",time_spent_minutes:0,hints_used:0});return await u(),n},async getUserSubmissions(e,s){console.log("Fetching user submissions for:",e);let t=i.from("submissions").select("*").eq("user_id",e).order("created_at",{ascending:!1});s&&(t=t.limit(s));const{data:r,error:n}=await t;if(n)throw console.error("Error fetching user submissions:",n),n;return console.log("Fetched submissions:",r),r||[]},async getUserSubmissionForProblem(e,s){console.log("Fetching submission for user:",e,"problem:",s);const{data:t,error:r}=await i.from("submissions").select("*").eq("user_id",e).eq("problem_id",s).maybeSingle();if(r)throw console.error("Error fetching user submission for problem:",r),r;return console.log("Found submission:",t),t},async getSubmissionStats(e){console.log("Fetching submission stats for:",e);const{data:s,error:t}=await i.from("submissions").select("status, time_spent_minutes, created_at").eq("user_id",e);if(t)throw console.error("Error fetching submission stats:",t),t;const r=s||[];console.log("Submissions for stats:",r);const n={total:r.length,attempted:r.filter(o=>o.status==="attempted").length,solved:r.filter(o=>o.status==="solved").length,partially_solved:r.filter(o=>o.status==="partially_solved").length,skipped:r.filter(o=>o.status==="skipped").length,totalTime:r.reduce((o,a)=>o+(a.time_spent_minutes||0),0),accuracy:r.length>0?Math.round(r.filter(o=>o.status==="solved").length/r.length*100):0};return console.log("Calculated stats:",n),n}};export{d as g,m as l,b as s};
